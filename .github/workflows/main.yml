name: CI/CD for iOS

on:
  pull_request:
  push:
    branches:
      # - main # Triggers on push to the main branch
      # 1. Standard branches (explicit names)
      - develop
      - main 
      - stage
      
      # 2. Feature branches (using a wildcard)
      - 'feature/main_*'
      - 'feature/*'
      
      # 3. Release branches (using a wildcard)
      - 'release/**'

jobs:
  # 1. BUILD and TEST Job
  build_and_test:
    name: Build & Test üß™
    runs-on: macos-latest # Use a specific macOS version (e.g., macos-14) for stability if needed

    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4 # Use the latest version

    # --- NEW: Robust Xcode Selection (Select 16.2, install if needed, then fallback) ---
    # This action abstracts the complex logic to check, install (if necessary),
    # and select the specific Xcode version (16.2). If 16.2 cannot be made available,
    # it will automatically fall back to the default installed version.
    - name: Select or Install Xcode 16.2
      uses: rfd/setup-xcode@v1
      with:
        version: '16.2'

    - name: Show Current Xcode version (Verification)
      run: xcodebuild -version

    - name: üíé Install Ruby & Dependencies
      # Setup Ruby before installing gems, necessary for Bundler/Fastlane
      uses: ruby/setup-ruby@v1
      with:
        # Use the Ruby version specified in your Gemfile/Gemfile.lock, or a stable default
        ruby-version: '3.3' 
        bundler-cache: true # Installs gems and caches them for faster builds

    - name: üì¶ Finalize Gem Installation
      run: |
        cd ./Swift-CI-CD
        bundle config set --local path 'vendor/bundle'
        # Now run install, which puts everything in vendor/bundle/
        bundle install

    # No need to explicitly call 'bundle install' and 'fastlane install_plugins' 
    # if 'bundler-cache: true' is used and your Gemfile is correct.

    - name: üîÑ Reset Swift Package Caches
      run: |
        # ‚û°Ô∏è FIX: Change directory before running xcodebuild
        cd ./Swift-CI-CD
        xcodebuild -resolvePackageDependencies -target "Swift-CI-CD" -configuration 'Release(UAT)'

    - name: üèÉ Run Build and Test Lane
      run: |
        # ‚û°Ô∏è FIX: Change directory before executing Fastlane
        cd ./Swift-CI-CD
        bundle exec fastlane ios build_and_test device:"iPhone 15"
    
      
    # üí° If you need to pass files (like .ipa) to the deploy job, add an artifact upload step here:
    # - name: Upload Artifacts
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: built-ipa
    #     path: ./fastlane/builds/*.ipa # Adjust path to your build output
      
  # 2. DEPLOY Job
  # deploy:
  #   name: Deploy to App Store üöÄ
  #   needs: build_and_test # This job only runs if 'build_and_test' job succeeds
  #   runs-on: macos-latest

  #   # Add environment variables here for Fastlane to access
  #   env:
  #     FASTLANE_USER: ${{ secrets.FASTLANE_USER }} # Your Apple ID email
  #     FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }} # App-specific password
  #     # Optional: To skip interactive authentication checks
  #     FASTLANE_SKIP_PDF_GENERATION: 1
  #     FASTLANE_SKIP_COLLECT_AND_SUBMIT_LOGS: 1
      
  #   steps:
  #   - name: ‚¨áÔ∏è Checkout repository
  #     uses: actions/checkout@v4
      
  #   - name: üçé Select Xcode Version
  #     # Re-use the same setup-xcode action
  #     uses: maxim-lobanov/setup-xcode@v1 
  #     with:
  #       xcode-version: '16.2'

  #   - name: üíé Install Ruby & Dependencies
  #     # Install gems again in this job
  #     uses: ruby/setup-ruby@v1
  #     with:
  #       ruby-version: '3.3'
  #       bundler-cache: true
        
  #   # üí° If using artifacts: Download them here instead of rebuilding
  #   # - name: Download Artifacts
  #   #   uses: actions/download-artifact@v4
  #   #   with:
  #   #     name: built-ipa
  #   #     path: ./fastlane/builds

  #   - name: ‚¨ÜÔ∏è Deploy to App Store
  #     # IMPORTANT: If you are using artifacts, you might modify your Fastfile 
  #     # to skip the 'gym' step in the deploy lane since the IPA is already built.
  #     run: bundle exec fastlane ios deploy_to_app_store