# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

opt_out_usage

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# default_platform(:ios)

# platform :ios do
#   desc "Description of what the lane does"
#   lane :custom_lane do
#     # add actions here: https://docs.fastlane.tools/actions
#   end
# end


platform :ios do
  desc "This is CI/CD for automation test, build, archive and deploy with environment UAT"
  # ‚û°Ô∏è CONFIGURATION: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL VALUES ‚¨ÖÔ∏è
  # Use either 'project_path' OR 'workspace_path', not both.
  project_path = "Swift-CI-CD.xcodeproj"
  # workspace_path = "YourAppName.xcworkspace" # Uncomment if you use a workspace (e.g., with CocoaPods)
  scheme_name = "Production"
  build_scheme = "Release(Prod)" 
  
  # --- Lane for Continuous Integration (CI) and Local Testing ---
  lane :build_and_test do
    # Get the current branch name
    branch = git_branch

    # --- Conditional Logic ---
    if branch.start_with?("feature/main_")
      UI.message("üõ†Ô∏è Feature Branch Detected: #{branch}. Building with Debug/UAT config.")
      
      # Configuration for feature development and testing
      build_scheme = "Debug(UAT)"
      scheme_name = "UAT" 

    elsif branch.start_with?("release/")
      UI.message("üì¢ Release Branch Detected: #{branch}. Building with Release/Staging config.")
      
      # Configuration for release candidates, testing release signing/performance
      build_scheme = "Release(Stage)" # Could be your main Production scheme
      scheme_name = "Stage" # Typically use Release config for release branches

    else
      UI.message("‚öôÔ∏è Default Branch Detected: #{branch}. Using standard configuration.")
      
      # Default configuration (e.g., building from 'main' or local test)
      build_scheme = "Release(Prod)"
      scheme_name = "Production"
    end
    # --- End of Conditional Logic ---

    # 1. (Optional) Install dependencies if needed (e.g., if using CocoaPods)
    # cocoapods 
    
    # 2. Build the project for the iOS Simulator (Fast and suitable for testing)
    gym(
      scheme: scheme_name,
      project: project_path, # Use this OR workspace: workspace_path
      configuration: build_scheme, # "Release(UAT)",
      sdk: "iphonesimulator", # CRUCIAL: Fixes the 'no such module UIKit' error for testing
      clean: true,
      xcargs: "VERBOSE_SCRIPT_LOGGING=YES",
    )
    
    # 3. Run tests on a specified simulator
    scan(
      scheme: scheme_name,
      project: project_path, # Use this OR workspace: workspace_path
      device: "iPhone 15", # Specify a common simulator device
      sdk: "iphonesimulator",
      clean: true
    )
    
    # Optional: Add a notification if tests pass
    # slack(message: "Tests for #{scheme_name} passed successfully!")
  end
  
  # --- Lane for Deployment to App Store Connect (TestFlight/Production) ---
  # lane :deploy_to_app_store do
  #   # 1. Update the build number BEFORE building
  #   increment_build_number(
  #     xcodeproj: project_path 
  #   )

  #   # 2. Build the App Store Release Archive
  #   gym(
  #     scheme: scheme_name,
  #     project: project_path, # Use this OR workspace: workspace_path
  #     configuration: "Release(Prod)",
  #     export_method: "app-store", # ESSENTIAL for distribution
  #     sdk: "iphoneos", # CRUCIAL: Targets the device SDK for a valid archive
  #     output_directory: "./fastlane/builds", # Define where the IPA goes
  #     clean: true,
  #     silent: true
  #   )
    
  #   # 3. Deploy to App Store Connect (TestFlight or Production)
  #   deliver(
  #     ipa: "./fastlane/builds/#{scheme_name}.ipa",
  #     # Set 'force: true' to handle possible version errors during deployment
  #     force: true
  #   )
    
  #   # Optional: Post-deployment notification
  #   # slack(message: "New version of #{scheme_name} deployed to App Store Connect!")
  # end
end