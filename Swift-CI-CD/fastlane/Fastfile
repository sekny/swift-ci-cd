# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

opt_out_usage

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# default_platform(:ios)

# platform :ios do
#   desc "Description of what the lane does"
#   lane :custom_lane do
#     # add actions here: https://docs.fastlane.tools/actions
#   end
# end


platform :ios do
  desc "This is CI/CD for automation test, build, archive and deploy with environment UAT"
  # ‚û°Ô∏è CONFIGURATION: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL VALUES ‚¨ÖÔ∏è
  # Use either 'project_path' OR 'workspace_path', not both.
  project_path = "Swift-CI-CD.xcodeproj"
  # workspace_path = "YourAppName.xcworkspace" # Uncomment if you use a workspace (e.g., with CocoaPods)
  scheme_name = "Production"
  build_scheme = "Release(Prod)" 
  
  # --- Lane for Continuous Integration (CI) and Local Testing ---
  lane :build_and_test do
    # 1. FIX: Explicitly select the Xcode version (based on your runner's available version).
    # xcode_select "/Applications/Xcode_16.2.app"

    # 2. Ensure a clean build environment
    clear_derived_data
    # Get the current branch name
    branch = git_branch

    # --- Conditional Logic ---
    if branch == "main"
      UI.message("üõ†Ô∏è Main Branch Detected: #{branch}. Building with Release(UAT) config.")
      
      # Configuration for feature development and testing
      build_scheme = "Debug(UAT)"
      scheme_name = "UAT" 
    
    elsif branch.start_with?("feature/main_")
      UI.message("üõ†Ô∏è Feature Branch Detected: #{branch}. Building with Release(UAT) config.")
      
      # Configuration for feature development and testing
      build_scheme = "Debug(UAT)"
      scheme_name = "UAT" 
    
    elsif branch.start_with?("feature/")
      UI.message("‚öôÔ∏è Default Branch Detected: #{branch}. Building with Release(UAT) config.")
      
      # Default configuration (e.g., building from 'main' or local test)
      build_scheme = "Release(UAT)"
      scheme_name = "UAT"

    elsif branch.start_with?("release/")
      UI.message("üì¢ Release Branch Detected: #{branch}. Building with Release(Prod) config.")
      
      # Configuration for release candidates, testing release signing/performance
      build_scheme = "Release(Prod)" # Could be your main Production scheme
      scheme_name = "Production" # Typically use Release config for release branches

    elsif branch == "stage"
      UI.message("‚öôÔ∏è Default Branch Detected: #{branch}. Building with Release(Stage) config.")
      
      # OVERRIDE 2: Staging Environment (Use Release config for better testing)
      build_scheme = "Release(Stage)"
      build_config = "Stage" 

    elsif branch == "develop"
      UI.message("‚öôÔ∏è Default Branch Detected: #{branch}. Building with Release(SIT) config.")
      
      # OVERRIDE 3: Development Integration (Standard Integration testing)
      build_scheme = "Debug(SIT)" # A scheme often pointing to a separate dev server
      build_config = "SIT"
    end
    # --- End of Conditional Logic ---

    # --- CRITICAL FIX: Explicitly set a safe Deployment Target (e.g., 16.0) ---
    # This overrides the problematic iOS 26.1 requirement from the project settings.
    safe_deployment_target = "16.0"
    deployment_arg = "IPHONEOS_DEPLOYMENT_TARGET=#{safe_deployment_target}"

    # 1. (Optional) Install dependencies if needed (e.g., if using CocoaPods)
    # cocoapods 
    
    # 2. Build the project for the iOS Simulator (Fast and suitable for testing)
    gym(
      scheme: scheme_name,
      project: project_path, # Use this OR workspace: workspace_path
      configuration: build_scheme, # "Release(UAT)",
      sdk: "iphonesimulator", # CRUCIAL: Fixes the 'no such module UIKit' error for testing
      destination: "platform=iOS Simulator,name=iPhone 15",
      skip_archive: true,
      clean: true,
      xcargs: "#{deployment_arg} VERBOSE_SCRIPT_LOGGING=YES",
    )
    
    # 3. Run tests on a specified simulator
    scan(
      scheme: scheme_name,
      project: project_path, # Use this OR workspace: workspace_path
      # destination: "platform=iOS Simulator,name=iPhone 15,OS=17.5",

      # CRITICAL FIX: Disable code signing and provisioning requirements.
      # This prevents the build failure (Exit status: 65) caused by missing certificates on the CI runner.
      # xcargs: "CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO",

      # device: "iPhone 15", # Specify a common simulator device
      devices: ["iPhone 15"], # Specify a common simulator device
      sdk: "iphonesimulator",
      destination: "platform=iOS Simulator,name=iPhone 15",
      clean: false, # Already cleaned by gym

      xcargs: "#{deployment_arg} CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO",

      # Specify the UI test bundle to run
      # only_testing: [
      #   "Swift_CI_CDUITests/Swift_CI_CDUITests" 
      # ],

      # Output options
      # output_directory: "./test_output",
      # output_types: "junit,html",
      # include_simulator_logs: true
    )
    
    # Optional: Add a notification if tests pass
    # slack(message: "Tests for #{scheme_name} passed successfully!")
  end
  
  # --- Lane for Deployment to App Store Connect (TestFlight/Production) ---
  lane :deploy_to_app_store do
    # # 1. Update the build number BEFORE building
    # increment_build_number(
    #   xcodeproj: project_path 
    # )

    # # 2. Build the App Store Release Archive
    # gym(
    #   scheme: scheme_name,
    #   project: project_path, # Use this OR workspace: workspace_path
    #   configuration: "Release(Prod)",
    #   export_method: "app-store", # ESSENTIAL for distribution
    #   sdk: "iphoneos", # CRUCIAL: Targets the device SDK for a valid archive
    #   output_directory: "./fastlane/builds", # Define where the IPA goes
    #   clean: true,
    #   silent: true
    # )
    
    # # 3. Deploy to App Store Connect (TestFlight or Production)
    # deliver(
    #   ipa: "./fastlane/builds/#{scheme_name}.ipa",
    #   # Set 'force: true' to handle possible version errors during deployment
    #   force: true
    # )
    
    # Optional: Post-deployment notification
    # slack(message: "New version of #{scheme_name} deployed to App Store Connect!")
  end
end